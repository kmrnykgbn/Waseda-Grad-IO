---
title: "Appendix: Source code"
output:
  pdf_document:
    latex_engine: pdflatex
    keep_tex: true
  html_document:
    df_print: paged
date: "2024-05-21"
---

```{r setup, include=TRUE, echo=TRUE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
gc()
set.seed(1)
options(digits=5) 
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  plm,
  ggplot2,
  tidyverse,
  fixest,
  knitr,
  kableExtra,
  tidymodels,
  modelsummary,
  ggplot2,
  skimr
)
```

### Data
```{r echo=TRUE, include=TRUE}

orig_df <- read_csv("./input/WSDR.csv")
head(orig_df, 30)
```


## Answer to Q1
```{r echo=TRUE, include=TRUE}
### Q1 Answer ###
stats <- orig_df %>%
  dplyr::select(move,price, profit, custcoun) %>%
  skimr::skim(.) %>%
  skimr::yank("numeric") %>%
  dplyr::select(skim_variable, mean, sd, p0, p100) %>%
  dplyr::mutate_at(vars(mean, sd, p0, p100), ~round(., 3)) %>%
  kable(format = "latex")
print(stats)
```

## Answer to Q2
```{r echo=TRUE, include=TRUE}
### Q2 Answer ###

# to factor
df <- orig_df |>
  mutate(upc = factor(upc)) |>
  arrange(week, store, upc)

# compute market share
df <- df |>
  dplyr::group_by(store, week) |>
  mutate(M_t = sum(custcoun),
         tot_quant_t = sum(move),
         s_jt = move / M_t,
         s_0t = (M_t- tot_quant_t) / M_t,
         logit_share = log(s_jt/s_0t)) |>
  ungroup() |>
  select(-c(M_t, tot_quant_t))

# compute iV
df <- df |>
  mutate(whole_p_jt = price * (1 - profit))

# OLS estimation in Berry's logit
model1_OLS <- feols(logit_share ~  price + i(upc), 
               df, vcov="hetero"
)

# IV estimation in Berry's logit
model1_IV <- feols(logit_share ~  i(upc) | price ~ whole_p_jt, 
               df, vcov="hetero"
)

# First stage
etable(model1_IV, stage = 1, fitstat=~ . + ivfall + ivwaldall.p,
       signif.code=c("***"=0.01,"**"=0.05,"*"=0.10), 
       style.tex = style.tex("aer"),  tex = TRUE,
       digits=3, digits.stats=3)

# Estimation result
etable(model1_OLS, model1_IV, stage = 2, fitstat=~ . + ivfall + ivwaldall.p,
       signif.code=c("***"=0.01,"**"=0.05,"*"=0.10), 
       style.tex = style.tex("aer"),  tex = TRUE,
       digits=3, digits.stats=3)
```

## Answer to Q4
```{r echo=TRUE, include=TRUE}
### Q4 Answer ###

# compute own elasticity for each market
own_elas_jt <- df |>
  select(upc, descrip, price, s_jt) |>
  mutate(own_elas = model1_IV$coefficients["fit_price"] * price * (1 - s_jt)) 

# take median of own elasticity by upc
own_elas_df <- own_elas_jt |>
  group_by(upc, descrip) |>
  summarize(own_elas = median(own_elas))

# compute cross elasticity for each market
cross_elas_jt <- df |>
  select(descrip, upc, price, s_jt) |>
  mutate(cross_elas = (-1) * model1_IV$coefficients["fit_price"] * price * s_jt)
  
# take median of cross elasticity by upc
cross_elas_df <- cross_elas_jt |>
  group_by(upc, descrip) |>
  summarize(cross_elas = median(cross_elas))

# create cross elasticity matrix
J <- nrow(cross_elas_df)
S_p_med <- matrix( rep(cross_elas_df$cross_elas, J), nrow = J, ncol = J)
diag(S_p_med) <- own_elas_df$own_elas
colnames(S_p_med) <- rownames(S_p_med) <- as.character(cross_elas_df$descrip)
S_p_med
```

## Answer to Q5
```{r echo=TRUE, include=TRUE}
### Q5 Answer ###

# create elasticity matrix S(p) for upc and market
J <- nrow(cross_elas_jt)
S_p <- matrix( rep(cross_elas_jt$cross_elas, J), nrow = J, ncol = J)
diag(S_p) <- own_elas_jt$own_elas
colnames(S_p) <- rownames(S_p) <- as.character(cross_elas_df$descrip)
S_p
```